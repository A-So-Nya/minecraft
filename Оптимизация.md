Майнкрафт, особенно с модами - далеко на самая лёгкая игра, анон. Поэтому, попробовав игру, ты можешь оказаться не доволен полученым FPS'ом или TPS'ом (тиками в секунду, их низкое количество видно по задержкам в разбиении блоков, медленном редстоуне, не генерериующимся мире), поэтому ты можешь захотеть изменить это, анон!

_**JVM флаги**_

**WARNING**

**Для части флагов нужна или серверная версия JRE, или JDK**

**https://adoptopenjdk.net/?variant=openjdk8&jvmVariant=openj9**

**https://adoptopenjdk.net/**

**Работает и для ваниллы, и для модов**

**-Xms и -Xmx**

Эти флаги указывают, сколько выделяется оперативной памяти для **heap'а** JVM. Это значит, что это не вся память, которая будет занята джавой. Выделяйте, сколько не жалко, но чтобы осталось ещё памяти на остальные области памяти JVM. Оптимальное значение подбирается экспериментальным путём. Если выделите слишком много, то сборщику мусора придётся сканировать большие объёмы памяти и это приведёт к снижению производительности. Если выделить слишком мало, то сборщик мусор будет выделяться слишком часто. Для машин с 8 гигабайтами оперативки я могу посоветовать -Xmx4G -Xms4G. Оба значения должны быть равны.

**-XX:+UseG1GC**

Включает более подходящий для игры сборщик мусора

**-XX:+UnlockExperimentalVMOptions**

Делает доступными часть опций, описанных ниже

**-XX:+DisableExplicitGC**

Запрещает самой игре вызывать сборщик мусора, он будет вызываться только тогда, когда нужен. Убирает часть лагспайков

**-XX:G1NewSizePercent=30**

Майнкрафту необходимо большее количество памяти под NewGen, чем установленные по-умолчанию 5%. При малом количестве сборщик мусора будет вызываться слишком часто и убивать TPS.

**-XX:G1MixedGCLiveThresholdPercent=90**

Указывает, при насколько заполненным регионах памяти, они будут включены в смешанную сборку мусора. Она легче, чем полная, поэтому лучше часто проводить её.

**-XX:G1ReservePercent=20**

Гарантирует, что у нас останется достаточно памяти, чтобы её же очистить

**-XX:MaxTenuringThreshold=1**

Max Tenuring 1 ensures that we do not promote transient data to old generation, but anything that survives 2 passes of Garbage Collection is just going to be assumed as longer-lived.

**-XX:SurvivorRatio=32**

Освобождает больше памяти Eden региону

**-XX:+AlwaysPreTouch**

Заранее выделяет всю память для JVM при запуске, что улучшает работу с памятью.

**-XX:MaxGCPauseMillis=200**

Устанавливает максимальную длинну паузы между сборками мусора.

**-XX:+ParallelRefProcEnabled**

Позволяет GC использовать несколько потоков

**-XX:G1RSetUpdatingPauseTimePercent=5**

Уменьшает паузы при работе с Rsets

**-XX:G1MixedGCCountTarget=4**

Пытаемся вернуть old gen быстрее

**-XX:G1HeapRegionSize=8M+**

Регионы памяти в heap'е

**-XX:PerfDisableSharedMem**

GC не будет писать на диск, что может вызывать лаги при большой нагрузке на диск

**-XX:G1HeapWastePercent=5**


**-XX:InitiatingHeapOccupancyPercent=15**

При выделении больших объёмов памяти heap'у и при поддержке системой, имеет смысл включить HugePages (требуется java>7):

**-XX:+UseLargePagesInMetaspace**

Источник: https://aikar.co/2018/07/02/tuning-the-jvm-g1gc-garbage-collector-flags-for-minecraft/


Копипаста другого гайда с https://cwelth.com/manuals.php?mid=2 (сайт уже падал один раз, имеет смысл перенести ценный гайд в безопасное место):


После выполнения рекомендаций из этого руководства, вы заметите следующее:

- Замедление операций по работе с памятью (из-за необходимости частого высвобождения)

- Ускорение обработки операций процессором и использование быстрых математических алгоритмов (Процессор будет использоваться более эффективно)

- Максимизировано использование Garbage Collector'а (сборка будет использовать минимальное количество памяти)

- Замедление загрузки модпака (из-за более эффективной работы с памятью)

- Более отзывчивый мир, более стабильный TPS (Из-за эффективной работы с ресурсами процессора)

- Большее количество параллельных вычислений (Больше параллельных потоков)

Начните тест со следующим набором аргументов (изменяйте их значения по необходимости):

-mx1G -XX:InitiatingHeapOccupancyPercent=10 -XX:AllocatePrefetchStyle=1 -XX:+UseSuperWord -XX:+OptimizeFill -XX:LoopUnrollMin=4 -XX:LoopMaxUnroll=16 -XX:+UseLoopPredicate -XX:+RangeCheckElimination -XX:+CMSCleanOnEnter -XX:+EliminateLocks -XX:+DoEscapeAnalysis -XX:+TieredCompilation -XX:+UseCodeCacheFlushing -XX:+UseFastJNIAccessors

-XX:+CMSScavengeBeforeRemark -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses -XX:+ScavengeBeforeFullGC -XX:+AlwaysPreTouch -XX:+UseFastAccessorMethods -XX:+UnlockExperimentalVMOptions -XX:G1HeapWastePercent=10 -XX:G1MaxNewSizePercent=10 -XX:G1HeapRegionSize=32M -XX:G1NewSizePercent=10 -XX:MaxGCPauseMillis=100 -XX:+OptimizeStringConcat -XX:+UseParNewGC -XX:+UseNUMA -XX:+UseCompressedOops -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled -XX:SurvivorRatio=2 -XX:+DisableExplicitGC




Аргументы, которые нужно изменять в первую очередь:

-mx1G

Динамическое выделение памяти. Этот флаг заставляет java выделять память динамически по мере необходимости, а не весь объем сразу.

Установите в значение максимально допустимого объема памяти.


-Xss2048k

Параметр изменяет размер стэка для потоков процессора (128, 512, 1024, 2048, 4096)

Установлено оптимальное значение, однако, можно поиграться с параметром, чтобы добиться большей стабильности (Может вызывать зависания!)


-XX:+UseLargePages

Установите этот флаг, если выделяете для сборки большое количество памяти.


-XX:ParallelGCThreads=8

Количество потоков Garbage Collector'а (1 физическое ядро = 1 поток, если у вас включен Hyperthreading, то 1 физическое ядро = 2 потока)

Установите согласно количеству ядер вашего процессора.


-XX:SurvivorRatio=1

Определяет "EDEN Space", каждая единица равна 0,5GB памяти для объектов, которые создаются при загрузке.

Определите, какую часть памяти вы готовы выделить на стартовые объекты.


-XX:MaxGCPauseMillis=250

Минимальная пауза между запуском Garbage Collector'а в миллисекундах.

Попробуйте выставлять разные значения, чтобы избежать небольшого периодического лага.


-XX:MaxMetaspaceSize=320m

Выделяет постоянную память. Алгоритм подразумевает использование 300 мебагайт на каждые 200 модов (в среднем).

Внимание! Этот флаг может вызывать ошибки "Out of memory"!



Аргументы, которые крайне рекомендуется включить в список запуска:


-mx1G

Динамическое выделение памяти. Этот флаг заставляет java выделять память динамически по мере необходимости, а не весь объем сразу.

Установите в значение максимально допустимого объема памяти.


-XX:+UseConcMarkSweepGC

Удаляет старые объекты из буфера Garbage Collector'а. Оптимизирует использование памяти.


-XX:+CMSClassUnloadingEnabled

Высвобождает выделенную, но давно не используемую память.


-XX:+DisableExplicitGC

Заставляет Garbage Collector игнорировать принудительные вызовы, которые могут отрицательно сказаться на производительности.


-XX:+UseCompressedOops

Позволяет использовать 32-битные ссылки в 64-битном окружении.

Сохраняет приличное количество памяти в некоторых случаях.


-XX:+UseNUMA

Включает использование архитектуры NUMA.

Оптимизирует алгоритмы работы с памятью и потоками процессора.


-XX:+UseParNewGC

Включает распараллеливание вызовов Garbage Collector'а.

Снижает задержки при вызовах GC, и заставляет игру выполняться более плавно.


-XX:G1NewSizePercent=10

Устанавливает процент памяти, которая будет выделяться на новые объекты при их создании.

Снижает используемый объем памяти.


-XX:G1ReservePercent=10

Резервирует процент памяти, используемый на G1.

Не только снижает используемый объем памяти, но и предотвращает ее глобальный рост.


-XX:G1HeapRegionSize=32M

Устанавливает размер области памяти для G1.

Помимо процентного указания, целесообразно указать и реальное значение памяти.


-XX:G1MaxNewSizePercent=10

Устанавливает максимальный процент памяти, которая будет выделяться на новые объекты при их создании.

Заставим наш GC запускаться чаще, но не слишком часто.


-XX:G1HeapWastePercent=10

Устанавливает процент "мусора" в GC, который считается допустимым.

Не будем засорять память всякой ненужной фигней.


-XX:+UnlockExperimentalVMOptions

Разрешает использование всех перечисляемых здесь аргументов.

Обязательно установите этот флаг, если играетесь с аргументами.


-XX:+OptimizeStringConcat

Произвольные недокументированные алгоритмы оптимизации работы со строками.

Видимо, что-то улучшает, но, главное, не делает хуже.


-XX:+UseFastAccessorMethods

Использовать оптимизированные методы доступа.

Исключает различные проверки при обращении к объектам. Увеличивает скорость работы, но может вызывать нестабильность, если автор мода - лентяй.


-XX:+AlwaysPreTouch

Очищает выделяемую область памяти перед использованием.

Замедляет загрузку, однако увеличивает общую производительность при работе с большими объемами памяти.


-XX:+ScavengeBeforeFullGC

Сначала очищает новые объекты в GC, а затем уже проводит полный цикл.

Снижает затраты памяти на GC.


-XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses

Отключает часовые перерывы в работе GC из RMI, и выгружает классы.

Разгружает память и снижает количество задержек при работе GC.


-XX:+CMSScavengeBeforeRemark

Пытается очистить мелкие объекты перед запуском полного цикла GC.

Снижает лаг, оптимизирует работу с памятью.


-XX:+AlwaysTenure

Использует старый алгоритм GC для оставшихся объектов.

Флаг нужно использовать при включении новых алгоритмов GC, однако, он нам ломает всю оптимизацию.

-XX:+UseFastJNIAccessors

Использовать быстрые алгоритмы доступа к сторонним библиотекам, написанным на других языках.


-XX:+UseCodeCacheFlushing

Сброс страниц кеша для снижения объема используемой памяти.


-XX:+TieredCompilation

Выключает компиляцию 1, 2 и 3 уровней для увеличения скорости компиляции.

Сильно оптимизирует работу процессора и памяти.


-XX:+AggressiveOpts

Использование этого флага совместно с "AutoBoxCacheMax" (который оптимизирует работу процессора) позволит поднять производительность за счет увеличения объема используемой памяти.

Включите этот флаг, если готовы пожертвовать дополнительными 10-50MB памяти.


-XX:+UseBiasedLocking

Используется на многоядерных процессорах для увеличения производительности параллельных вычислений.

Включите флаг, если у вас больше двух физических ядер.


-XX:+DoEscapeAnalysis

Оптимизирует задержки при параллельных вычислениях.

Включите флаг, если у вас больше двух физических ядер.


-XX:+EliminateLocks

Оптимизирует задержки при параллельных вычислениях.

Включите флаг, если у вас больше двух физических ядер.



-XX:+CompileThreshold

Использовать быстрый алгоритм профайлинга.

Может помочь со скоростью загрузки, однако не всегда работает.


-XX:+CMSCleanOnEnter

Улучшает производительность снижая допустимое количество "грязных карт".

Сам не понимаю, как это работает.

-XX:AllocatePrefetchStyle=1

Включает предзагружку бОльшего количества скомпилированного кода.

Флаг используется по-умолчанию в Java версий 9+

-XX:+UseSuperWord -XX:+OptimizeFill -XX:LoopUnrollMin=4 -XX:LoopMaxUnroll=16 -XX:+UseLoopPredicate -XX:+RangeCheckElimination

Увеличивает производительность циклов и использует оптимизированные вычислительные методы, для ускорения обработки.

Спасибо Ивану Мамонтову

-XX:InitiatingHeapOccupancyPercent=10

Определяет процент памяти, когда следует запустить Garbage Collector

Let's force the GC to collect at 10% of it's limit

Более часто - меньше производительность, менее часто - меньше использованной памяти.



Аргументы, которые не следует использовать:

-XX:+ReduceSignalUsage

Снижает количество сигнализации между VM и процессором.
Снижение производительности на 1-4%

-XX:+UseMembar

Включает алгоритм "true memory" для совместимости со старым кодом.
Снижение производительности на 10%

Другие флаги:

**-XX:+UseStringDeduplication** 

Каждая строчка может существовать только 1 раз, экономит память

**-XX:+RewriteBytecodes**

**-XX:+RewriteFrequentPairs**

Эти флаги обычно включены по-умолчанию и связаны с компиляцией байткода JVM машиной

**-XX:+UseInlineCaches**

**-XX:-DontCompileHugeMethods**

Заставляет джаву компилировать методы, превышающие установленный по-умолчанию лимит.

**-XX:UseSSE=**

Следует указать последнюю поддерживаемую вашим процессором версию SSE

**-Dsun.rmi.dgc.server.gcInterval=2147483646**

Говорит слою RMI не производить сборку мусора каждую минуту

Для 1.7.10 есть упоминания, о помощи флага **-Dforge.forceNoStencil=true**

_**Моды для оптимизации по версиям**_

_**Читайте конфиги модов! В описанных выше модах часто есть функции, которые могут прибавить F/T PS, но отключены по умолчанию! Также в крупных модах бывают опции для некропека**_

**Все, кроме, первое время после выхода, самой последней версии**

https://optifine.net/downloads - расширенные настройки графики. Можно выкрутить на минимум, чтобы не лагало, можно наоборот

**1.12.2**:

FoamFix: https://www.curseforge.com/minecraft/mc-mods/foamfix-optimization-mod - крайне рекоммендуется для использования, объединяет одинаковые модели, экономя память, позволяет отключать анимации у текстур (по-умолчанию отключено), имеет множество других полезных оптимизаций.

AI Improvements: https://www.curseforge.com/minecraft/mc-mods/ai-improvements - оптимизирует искуственный интелект мобов. Опционально отключает его неважные для игры части.

Surge: https://www.curseforge.com/minecraft/mc-mods/surge - мелкие оптимизации и один багфикс.

FastWorkbench: https://www.curseforge.com/minecraft/mc-mods/fastworkbench и FastFurnace: https://www.curseforge.com/minecraft/mc-mods/fastfurnace - оба слабо ощутимы не на больших серверах, но могут быть без проблем использованы.

Multithreaded Noise: https://www.curseforge.com/minecraft/mc-mods/multithreaded-noise - распараллеривает создание шума для генерации мира.

Performant: https://www.curseforge.com/minecraft/mc-mods/performant - различные крупные оптимизации. В прошлом были проблемы с частью модов (Vampirism, Rats), сейчас возможно стало лучше.

Unloader: https://www.curseforge.com/minecraft/mc-mods/unloader - выгружает неиспользуемые измерения, способен этим исправлять утечки памяти.

TexFix: https://www.curseforge.com/minecraft/mc-mods/texfix - экономит память при использовании крупных текстурпаков.

Phosphor: https://www.curseforge.com/minecraft/mc-mods/phosphor-forge - оптимизации движка, отвечающего за свет.

BetterFps: https://www.curseforge.com/minecraft/mc-mods/betterfps - использует более быстрые sin() и cos() инструкции, имеет некоторые другие опции.

VanillaFix: https://www.curseforge.com/minecraft/mc-mods/vanillafix - исправляет баги, добавляет оптимизаций, позволяет майнкрафту восстанавливаться после крашей. Musthave.

Chunk-Pregenerator: https://www.curseforge.com/minecraft/mc-mods/chunkpregenerator - позволяет заранее генерировать мир, оптимизации этой самой генерации

Clumps: https://www.curseforge.com/minecraft/mc-mods/clumps - объединяет entity xp в один, требует B.A.S.E https://www.curseforge.com/minecraft/mc-mods/base

**1.7.10**

BetterFps: https://www.curseforge.com/minecraft/mc-mods/betterfps - использует более быстрые sin() и cos() инструкции, имеет некоторые другие опции.

Fastcraft: https://www.curseforge.com/minecraft/mc-mods/fastcraft - много разных оптимизаций. Если используете optifine, выбирайте последнюю версию. Если нет, то 1.24

**Версии с Фабриком, рекомендуется поставить фабрик и приведённые ниже моды, даже если вы хотите просто играть на ванилле**

Phosphor: https://www.curseforge.com/minecraft/mc-mods/phosphor - оптимизации движка, отвечающего за свет.

Lithium: https://www.curseforge.com/minecraft/mc-mods/lithium - оптимизации всего, до чего дотянулся автор

Sodium: https://github.com/jellysquid3/sodium-fabric - от автора двух приведённых выше модов, требуется компилировать самому

FastWorkbench: https://www.curseforge.com/minecraft/mc-mods/fast-furnace-for-fabric и FastFurnace: https://www.curseforge.com/minecraft/mc-mods/fastbench-for-fabric - оба слабо ощутимы не на больших серверах, но могут быть без проблем использованы.


**Обновление библиотек старых версий**

Если вы играете в версию майнкрафта до 1.12.2, у вас могут быть недостаточно новые версии библиотек. В новых, как правило, лучше производительность, поэтому имеет смысл обновить их.

Скачайте майнкрафт версии 1.12.2 и замените файлами из директорий minecraft/libraries/org/lwjgl/lwjgl .minecraft/libraries/java3d/vecmath и .minecraft/versions/Forge 1.12.2/natives такие же файлы в более старой версии. Именно замените новыми файлами старые, используя такое же название!

**Отключение логов**

Если у вас медленный HDD, то может помочь отключение логгирования в майнкрафте. Для этого допишите в комманду запуска -Dlog4j.configurationFile=log4j2.xml и создайте в корне с игрой файл log4j2.xml со следующим содержанием:

<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="ERROR" packages="com.mojang.util">
    <Loggers>
        <Root level="OFF" additivity="false">
        </Root>
    </Loggers>
</Configuration>

**Ram-диск**
Если у вас ещё остаётся оперативная память, после запуска майнкрафта, вы можете перенести мир на ram-диск.

Не рекоммендуется использовать вместе с прегенерацией мира, если у вас мало оперативной памяти!

В Linux используется tmpfs со скриптами/юнитами/сервисами для бекапа, в Windows есть специальные программы для этого
